---
title: "EU Migration interactive map"
author: "Nikos Patias"
output: html_document
---

#install.packages("rgdal")
#install.packages("pryr")
#install.packages("rgeos")
#install.packages("htmlwidgets")
#install.packages("leaflet")


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```




## Create a list of the shapefiles inlcuded in the data folder

## The correct UK layer is UK_2011_404.shp

```{r}
# create a directory where the shapefiles are
dir <- paste0(getwd(),"/data_to_use")
file_list <- list.files(dir, pattern="*.shp$", full.names=TRUE)
file_list
```

## Read in the shapefiles for each country separately

```{r}
library(rgdal)

AUT <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[1])))

BEL <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[2])))

BRL <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[3])))

BUL <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[4])))

CHE <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[5])))

CZE <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[6])))

DNK <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[7])))

EST <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[8])))

FIN <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[9])))

GER <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[10])))

GRE <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[11])))

HUN <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[12])))

ITA <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[13])))

LTU <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[14])))

NLD <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[15])))

NOR <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[16])))

POL <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[17])))

POR <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[18])))

ROU <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[19])))

RUS <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[20])))

SPA <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[21])))

SWE <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[22])))

TUR <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[23])))

UK <- readOGR(dsn = "data_to_use", 
                layer = tools::file_path_sans_ext(basename(file_list[24])))



```

## Pre-process the data by each country so we keep the name of the region as well as the net migration and z scores 

## For the countries that they have names for two levels I used the level 2 which I believe corresponds to regions that we map

```{r}
# Print the names of the columns
str(AUT@data)

# Select the columns that we are interested in
AUT@data <- AUT@data[,c("name", "X3_2_nmr", "X3_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(AUT@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(BEL@data)

# Select the columns that we are interested in
BEL@data <- BEL@data[,c("name", "X9_3_nmr", "X9_3_z_nmr")]

# Rename the columns so there are consistent across countries

names(BEL@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(BRL@data)

# Select the columns that we are interested in
BRL@data <- BRL@data[,c("NAME_2", "X1_nmr", "X1_z_nmr")]

# Rename the columns so there are consistent across countries

names(BRL@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(BUL@data)

# Select the columns that we are interested in
BUL@data <- BUL@data[,c("NAME_2", "X5_nmr", "X5_z_nmr")]

# Rename the columns so there are consistent across countries

names(BUL@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(CHE@data)

# Select the columns that we are interested in
CHE@data <- CHE@data[,c("NAME", "X2_nmr", "X2_z_nmr")]

# Rename the columns so there are consistent across countries

names(CHE@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(CZE@data)

# Select the columns that we are interested in
CZE@data <- CZE@data[,c("Name", "X6_3_nmr", "X6_3_z_nmr")]

# Rename the columns so there are consistent across countries

names(CZE@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(DNK@data)

# Select the columns that we are interested in
DNK@data <- DNK@data[,c("name", "X4_nmr", "X4_z_nmr")]

# Rename the columns so there are consistent across countries

names(DNK@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(EST@data)

# Select the columns that we are interested in
EST@data <- EST@data[,c("NAME_2", "X7_2v_nmr", "X7_2v_z_nmr")]

# Rename the columns so there are consistent across countries

names(EST@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(FIN@data)

# Select the columns that we are interested in
FIN@data <- FIN@data[,c("Name", "X7_nmr", "X7_z_nmr")]

# Rename the columns so there are consistent across countries

names(FIN@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(GER@data)

# Select the columns that we are interested in
GER@data <- GER@data[,c("Name", "X6_nmr", "X6_z_nmr")]

# Rename the columns so there are consistent across countries

names(GER@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(GRE@data)

# Select the columns that we are interested in
GRE@data <- GRE@data[,c("Name", "X8_3_nmr", "X8_3_z_nmr")]

# Rename the columns so there are consistent across countries

names(GRE@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(HUN@data)

# Select the columns that we are interested in
HUN@data <- HUN@data[,c("NAME_2", "X4_2_nmr", "X4_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(HUN@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(ITA@data)

# Select the columns that we are interested in
ITA@data <- ITA@data[,c("name", "X9_2_nmr", "X9_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(ITA@data) <- c("name", "net_migr", "z_score")
```


### In Lithuania probably something is worng with the net migration. It seems identical to z score

```{r}
# Print the names of the columns
str(LTU@data)

# Select the columns that we are interested in
LTU@data <- LTU@data[,c("NAME_2", "X6_2v_nmr", "X6_2v_z_nmr")]

# Rename the columns so there are consistent across countries

names(LTU@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(NLD@data)

# Select the columns that we are interested in
NLD@data <- NLD@data[,c("Name", "X8_nmr", "X8_z_nmr")]

# Rename the columns so there are consistent across countries

names(NLD@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(NOR@data)

# Select the columns that we are interested in
NOR@data <- NOR@data[,c("Name", "X5_2_nmr", "X5_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(NOR@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(POL@data)

# Select the columns that we are interested in
POL@data <- POL@data[,c("NAME_2", "X4_3v_nmr", "X4_3v_z_nmr")]

# Rename the columns so there are consistent across countries

names(POL@data) <- c("name", "net_migr", "z_score")
```



```{r}
# Print the names of the columns
str(POR@data)

# Select the columns that we are interested in
POR@data <- POR@data[,c("ADMIN_NAME", "X3_nmr", "X3_z_nmr")]

# Rename the columns so there are consistent across countries

names(POR@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(ROU@data)

# Select the columns that we are interested in
ROU@data <- ROU@data[,c("Name", "X5_3_nmr", "X5_3_z_nmr")]

# Rename the columns so there are consistent across countries

names(ROU@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(RUS@data)

# Select the columns that we are interested in
RUS@data <- RUS@data[,c("Name", "X9_nmr", "X9_z_nmr")]

# Rename the columns so there are consistent across countries

names(RUS@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(SPA@data)

# Select the columns that we are interested in
SPA@data <- SPA@data[,c("Name", "X8_2_nmr", "X8_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(SPA@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(SWE@data)

# Select the columns that we are interested in
SWE@data <- SWE@data[,c("name", "X1_2_nmr", "X1_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(SWE@data) <- c("name", "net_migr", "z_score")
```

```{r}
# Print the names of the columns
str(TUR@data)

# Select the columns that we are interested in
TUR@data <- TUR@data[,c("Name", "X2_2_nmr", "X2_2_z_nmr")]

# Rename the columns so there are consistent across countries

names(TUR@data) <- c("name", "net_migr", "z_score")
```


```{r}
# Print the names of the columns
str(UK@data)

# Select the columns that we are interested in
UK@data <- UK@data[,c("geo_label", "uk_nmr", "uk_z_nmr")]

# Rename the columns so there are consistent across countries

names(UK@data) <- c("name", "net_migr", "z_score")
```


## Combine all the datasets

### something was wrong with Norway (NOR) CRS

```{r}
# Use the coordinate system of Netherlands
# The coordinate system is WGS84
identical_crs <- proj4string(NLD)

# and transform Norway to be compatible
NOR <-spTransform(NOR,CRS(identical_crs))



```


## I downloaded the European countries boundaries (i.e. NUTS 0) from https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts#nuts16 and then selected the countries that are mising from the dataset of net migration

```{r}
# read in the missing countries boundaries
missing <- readOGR(dsn = "data_missing", 
                layer = "European_countries_modified")

# Print the names of the columns
str(missing@data)

# create two new columns for net migration and z score to be consistent to the other datasets and fill them with NA values
missing@data$net_migr <- NA
missing@data$z_score <- NA

# Select the columns that we are interested in
missing@data <- missing@data[,c("NUTS_NAME", "net_migr", "z_score")]

# Rename the columns so there are consistent across countries

names(missing@data) <- c("name", "net_migr", "z_score")

```


```{r}
# Combine all the datasets into one
combined_data <- rbind(AUT, BEL, BRL, BUL, CHE, CZE, DNK, EST, FIN, GER, GRE, HUN, ITA, LTU, 
                       NLD, NOR, POL, POR, ROU, RUS, SPA, SWE, TUR, UK, missing)

# If we want it as a seperate shapefile
# writeOGR(combined_data , ".", "combined_data", driver="ESRI Shapefile")

summary(combined_data@data)

```

## Simplify the shapefile as it is too big

```{r}
library(pryr)
# check the size of the original shapefile
pryr::object_size(combined_data)

```

```{r}
library(rgeos)

# Simplify the shapefile but it does not preserve the columns
combined_data_simpl <- gSimplify(combined_data, tol = 0.001, topologyPreserve=TRUE)

# I create a dataframe with the data from the combined data
combined_data_df <- combined_data@data

# Combine spatial polygons and data
combined_data_simpl <- SpatialPolygonsDataFrame(combined_data_simpl, combined_data_df)

# check the size of the simplified shapefile
pryr::object_size(combined_data_simpl)

```

## Categorise data so to specify colours and labels for the map

```{r}
# categorise data
combined_data_simpl$z_cat <- cut(combined_data_simpl$z_score,
                   breaks=c(-Inf, -2.0, -0.001, 0.001, 2.0, Inf),
                   labels=c("less than -2", "-2 to 0", "0", "0 to 2", "more than 2"))

```



```{r, fig.width=10,fig.height=7}
library(leaflet)

# Specify the colour palette
pal <- colorFactor(palette = c("red", "salmon1", "white", "steelblue1", "blue"), 
           levels = c("less than -2", "-2 to 0", "0", "0 to 2", "more than 2"), ordered = FALSE)

# pal <- colorBin("RdYlBu", domain = spdf$z_score, bins = bins)

# There is a list of all the available background tiles in
# http://leaflet-extras.github.io/leaflet-providers/preview/index.html
# Create the initial background map, zooming in Europe
colourmap <- leaflet() %>% 
  addTiles() %>% 
  setView(lat = 48, lng = 20, zoom = 4) %>% 
  addProviderTiles(providers$NASAGIBS.ViirsEarthAtNight2012, group = "NASAGIBS.ViirsEarthAtNight2012") %>% 
  addProviderTiles(providers$Stamen.TonerLite, group = "Stamen.TonerLite")

# Create the interactive map showing the sequence clusters
interactive_map <- colourmap %>%
  addPolygons(data = combined_data_simpl,
              fillColor = ~pal(z_cat),
              weight = 0.4,
              opacity = 0.8,
              color = "black",
              dashArray = "3",
              fillOpacity = 0.7,
              popup = paste("Name: ", combined_data_simpl$name, "<br>",
                            "Net Migration: ", combined_data_simpl$net_migr, "<br>"),
              group = "Net migration in Europe",
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE)) %>% 
  addLegend(pal = pal,
            values  = combined_data_simpl$z_cat,
            na.label = "Missing data",
            position = "bottomleft",
            title = "Net migration in Europe (z-scores)") %>% 
  addLayersControl(baseGroups = c("NASAGIBS.ViirsEarthAtNight2012", "Stamen.TonerLite"),
    overlayGroups = "Net migration in Europe",
    options = layersControlOptions(collapsed = FALSE))


interactive_map


```

## If we want to save only the map

```{r}
library(htmlwidgets)
saveWidget(interactive_map, file="map.html", title = "Net Migration in Europe", selfcontained=TRUE)
```

```{r}

# shhh <- readOGR(dsn = dirname(ff[1]), layer = basename(ff[1])) 
# 
# shhhdddd <- readOGR(dsn = "data_to_use", 
#                 layer = tools::file_path_sans_ext(basename(ff[1])))
# 
# shhhdddd@data
# 
# 
# basename(ff[1])
# dirname(ff[1])
# 
# getwd()
# 
# tools::file_path_sans_ext(basename(ff[1]))
# paste0("../data_to_use/",basename(ff[1]))
```






